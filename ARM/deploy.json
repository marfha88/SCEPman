{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "OrgName": {
            "minLength": 2,
            "type": "String",
            "metadata": {
                "description": "Name of the Company or Organization used for the Certificate Subject"
            }
        },
        "license": {
            "defaultValue": "trial",
            "type": "String",
            "metadata": {
                "description": "License Key for SCEPman"
            }
        },
        "keyVaultName": {
            "defaultValue": "kv-scepman-UNIQUENAME",
            "minLength": 3,
            "maxLength": 24,
            "type": "String",
            "metadata": {
                "description": "Specifies the name of the Azure Key Vault. The name of a Key Vault must be globally unique and contain only DNS-compatible characters (letters, numbers, and hyphens)."
            }
        },
        "caKeyType": {
            "defaultValue": "RSA-HSM",
            "allowedValues": [
                "RSA",
                "RSA-HSM"
            ],
            "type": "String",
            "metadata": {
                "description": "When generating the SCEPman CA certificate, which kind of key pair shall be created? RSA is a software-protected RSA key; RSA-HSM is HSM-protected."
            }
        },
        "storageAccountName": {
            "defaultValue": "stgscepmanUNIQUENAME",
            "minLength": 3,
            "maxLength": 24,
            "type": "String",
            "metadata": {
                "description": "Choose a globally unique name for your storage account. Storage account names must be between 3 and 24 characters in length and may contain numbers and lowercase letters only."
            }
        },
        "appServicePlanName": {
            "defaultValue": "asp-scepman-UNIQUENAME",
            "maxLength": 40,
            "type": "String"
        },
        "existingAppServicePlanID": {
            "defaultValue": "none",
            "type": "String",
            "metadata": {
                "description": "Provide the AppServicePlan ID of an existing App Service Plan. Keep default value 'none' if you want to create a new one."
            }
        },
        "primaryAppServiceName": {
            "defaultValue": "as-scepman-UNIQUENAME",
            "maxLength": 60,
            "type": "String",
            "metadata": {
                "description": "The SCEPman App Service and part of the default FQDN. Therefore, it must be globally unique and contain only DNS-compatible characters."
            }
        },
        "certificateMasterAppServiceName": {
            "defaultValue": "as-scepman-UNIQUENAME-cm",
            "maxLength": 60,
            "type": "String",
            "metadata": {
                "description": "The App Service for the component SCEPman Certificate Master. As it is part of the default FQDN, it must be globally unique and contain only DNS-compatible characters."
            }
        },
        "location": {
            "defaultValue": "[resourceGroup().location]",
            "type": "String",
            "metadata": {
                "description": "Location for all resources. For a manual deployment, we recommend the default value."
            }
        },
        "resourceTags": {
            "defaultValue": {},
            "type": "Object",
            "metadata": {
                "description": "Tags to be assigned to all created resources. Use JSON syntax, e.g. if you want to add tags env with value dev and project with value scepman, then write { \"env\":\"dev\", \"project\":\"scepman\"}."
            }
        }
    },
    "variables": {
        "artifactsRepositoryUrl": "https://raw.githubusercontent.com/scepman/install/master/",
        "ArtifactsLocationSCEPman": "[uri(variables('artifactsRepositoryUrl'),'dist/Artifacts.zip')]",
        "ArtifactsLocationCertMaster": "[uri(variables('artifactsRepositoryUrl'),'dist-certmaster/CertMaster-Artifacts.zip')]",
        "templateRepositoryUrl": "https://raw.githubusercontent.com/scepman/install/prod/",
        "appSvcTemplateUri": "[uri(variables('templateRepositoryUrl'), 'nestedtemplates/appSvcDouble.json')]",
        "vaultTemplateUri": "[uri(variables('templateRepositoryUrl'), 'nestedtemplates/vault.json')]",
        "appConfigTemplateUri": "[uri(variables('templateRepositoryUrl'), 'nestedtemplates/appConfig-scepman.json')]",
        "appConfigCertMasterTemplateUri": "[uri(variables('templateRepositoryUrl'), 'nestedtemplates/appConfig-certmaster.json')]",
        "stgAccountTemplateUri": "[uri(variables('templateRepositoryUrl'), 'nestedtemplates/stgAccount.json')]"
    },
    "resources": [
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "pid-a262352f-52a9-4ed9-a9ba-6a2b2478d19b-partnercenter",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "resources": []
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "SCEPmanAppServices",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('appSvcTemplateUri')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "AppServicePlanName": {
                        "value": "[parameters('AppServicePlanName')]"
                    },
                    "existingAppServicePlanID": {
                        "value": "[parameters('existingAppServicePlanID')]"
                    },
                    "appServiceName": {
                        "value": "[parameters('primaryAppServiceName')]"
                    },
                    "appServiceName2": {
                        "value": "[parameters('certificateMasterAppServiceName')]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "resourceTags": {
                        "value": "[parameters('resourceTags')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "SCEPmanVault",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('vaultTemplateUri')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "keyVaultName": {
                        "value": "[parameters('keyVaultName')]"
                    },
                    "permittedPrincipalId": {
                        "value": "[reference('SCEPmanAppServices').outputs.scepmanPrincipalID.value]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "resourceTags": {
                        "value": "[parameters('resourceTags')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "DeploymentSCEPmanConfig",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('appConfigTemplateUri')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "StorageAccountTableUrl": {
                        "value": "[reference('SCEPmanStorageAccount').outputs.storageAccountTableUrl.value]"
                    },
                    "appServiceName": {
                        "value": "[parameters('primaryAppServiceName')]"
                    },
                    "scepManBaseURL": {
                        "value": "[reference('SCEPmanAppServices').outputs.scepmanURL.value]"
                    },
                    "keyVaultURL": {
                        "value": "[reference('SCEPmanVault').outputs.keyVaultURL.value]"
                    },
                    "caKeyType": {
                        "value": "[parameters('caKeyType')]"
                    },
                    "OrgName": {
                        "value": "[parameters('OrgName')]"
                    },
                    "WebsiteArtifactsUri": {
                        "value": "[variables('ArtifactsLocationSCEPman')]"
                    },
                    "license": {
                        "value": "[parameters('license')]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "DeploymentCertMasterConfig",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('appConfigCertMasterTemplateUri')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "appServiceName": {
                        "value": "[parameters('certificateMasterAppServiceName')]"
                    },
                    "scepmanUrl": {
                        "value": "[reference('SCEPmanAppServices').outputs.scepmanURL.value]"
                    },
                    "StorageAccountTableUrl": {
                        "value": "[reference('SCEPmanStorageAccount').outputs.storageAccountTableUrl.value]"
                    },
                    "WebsiteArtifactsUri": {
                        "value": "[variables('ArtifactsLocationCertMaster')]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "SCEPmanStorageAccount",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('stgAccountTemplateUri')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "StorageAccountName": {
                        "value": "[parameters('storageAccountName')]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "resourceTags": {
                        "value": "[parameters('resourceTags')]"
                    },
                    "tableContributorPrincipals": {
                        "value": [
                            "[reference('SCEPmanAppServices').outputs.scepmanPrincipalID.value]",
                            "[reference('SCEPmanAppServices').outputs.certmasterPrincipalID.value]"
                        ]
                    }
                }
            }
        }
    ]
}